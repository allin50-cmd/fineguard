trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

variables:
  - group: fineguard-prod-vars # Variable group in Azure DevOps
  - name: dockerRegistryServiceConnection
    value: 'fineguardacr75907'
  - name: imageRepository
    value: 'fineguard-api'
  - name: containerRegistry
    value: 'fineguardacr75907.azurecr.io'
  - name: dockerfilePath
    value: '$(Build.SourcesDirectory)/Dockerfile'
  - name: tag
    value: '$(Build.BuildId)'
  - name: vmImageName
    value: 'ubuntu-latest'

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildBackend
        displayName: 'Build Backend API'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Install Node.js 20'

          - script: |
              npm ci
              npm run test --if-present
            displayName: 'npm install and test'
            workingDirectory: $(Build.SourcesDirectory)

          - task: Docker@2
            displayName: 'Build Docker image'
            inputs:
              command: build
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Push Docker image to ACR'
            inputs:
              command: push
              repository: $(imageRepository)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest

      - job: BuildFrontend
        displayName: 'Build React Frontend'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Install Node.js 20'

          - script: |
              cd client
              npm ci
              npm run build
            displayName: 'Build frontend'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'client/dist'
              ArtifactName: 'frontend'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Deploy to Azure'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployBackend
        displayName: 'Deploy Backend to Container Apps'
        pool:
          vmImage: $(vmImageName)
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Deploy to Azure Container Apps'
                  inputs:
                    azureSubscription: 'Azure-Subscription'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az containerapp update \
                        --name fineguard-api \
                        --resource-group rg-fineguard-prod \
                        --image $(containerRegistry)/$(imageRepository):$(tag) \
                        --set-env-vars \
                          NODE_ENV=production \
                          DATABASE_URL="$(DATABASE_URL)" \
                          COMPANIES_HOUSE_API_KEY="$(COMPANIES_HOUSE_API_KEY)" \
                          PORT=8080

                - task: AzureCLI@2
                  displayName: 'Health Check'
                  inputs:
                    azureSubscription: 'Azure-Subscription'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      FQDN=$(az containerapp show \
                        --name fineguard-api \
                        --resource-group rg-fineguard-prod \
                        --query properties.configuration.ingress.fqdn -o tsv)

                      echo "Waiting for deployment to stabilize..."
                      sleep 30

                      echo "Testing health endpoint: https://$FQDN/health"
                      curl -f -s "https://$FQDN/health" || exit 1

                      echo "Health check passed!"

      - deployment: DeployFrontend
        displayName: 'Deploy Frontend to Static Web Apps'
        pool:
          vmImage: $(vmImageName)
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: frontend

                - task: AzureStaticWebApp@0
                  inputs:
                    app_location: '$(Pipeline.Workspace)/frontend'
                    skip_app_build: true
                    azure_static_web_apps_api_token: $(STATIC_WEB_APP_TOKEN)

  - stage: PostDeploy
    displayName: 'Post-Deployment Tasks'
    dependsOn: Deploy
    condition: succeeded()
    jobs:
      - job: DatabaseMigrations
        displayName: 'Run Database Migrations'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'

          - script: |
              npm ci
              npm run migrate --if-present
            displayName: 'Run migrations'
            env:
              DATABASE_URL: $(DATABASE_URL)

      - job: SmokeTests
        displayName: 'Run Smoke Tests'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: AzureCLI@2
            displayName: 'Run API smoke tests'
            inputs:
              azureSubscription: 'Azure-Subscription'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                FQDN=$(az containerapp show \
                  --name fineguard-api \
                  --resource-group rg-fineguard-prod \
                  --query properties.configuration.ingress.fqdn -o tsv)

                echo "Testing critical endpoints..."

                # Test /health
                curl -f "https://$FQDN/health" || exit 1

                # Test /api/companies
                curl -f "https://$FQDN/api/companies?limit=10" | jq '.companies | length' || exit 1

                # Test /api/accountants
                curl -f "https://$FQDN/api/accountants" | jq '.accountants | length' || exit 1

                echo "All smoke tests passed!"

      - job: NotifyTeam
        displayName: 'Send Deployment Notification'
        dependsOn: SmokeTests
        condition: succeeded()
        steps:
          - task: AzureCLI@2
            displayName: 'Send success notification'
            inputs:
              azureSubscription: 'Azure-Subscription'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ðŸŽ‰ Deployment $(Build.BuildId) successful!"
                echo "Backend: https://fineguard-api.greenmoss-3107b6a9.uksouth.azurecontainerapps.io"
                echo "Frontend: https://fineguard-frontend.azurestaticapps.net"

  - stage: Rollback
    displayName: 'Rollback if Failed'
    dependsOn: PostDeploy
    condition: failed()
    jobs:
      - job: RollbackDeployment
        displayName: 'Rollback to Previous Version'
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: AzureCLI@2
            displayName: 'Rollback Container App'
            inputs:
              azureSubscription: 'Azure-Subscription'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Get previous revision
                PREV_REVISION=$(az containerapp revision list \
                  --name fineguard-api \
                  --resource-group rg-fineguard-prod \
                  --query "[1].name" -o tsv)

                echo "Rolling back to revision: $PREV_REVISION"

                az containerapp revision activate \
                  --name fineguard-api \
                  --resource-group rg-fineguard-prod \
                  --revision $PREV_REVISION

                echo "Rollback complete"
