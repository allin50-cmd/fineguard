# Advanced Azure DevOps Pipeline for FineGuard
# Complete Infrastructure + Application Deployment

name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main
      - develop
      - release/*
  paths:
    exclude:
      - '**.md'
      - 'docs/**'

pr:
  branches:
    include:
      - main
      - develop

variables:
  - group: fineguard-prod # Secure variables
  - name: azureSubscription
    value: 'Azure-Production-ServiceConnection'
  - name: resourceGroup
    value: 'rg-fineguard-prod'
  - name: location
    value: 'uksouth'
  - name: containerRegistry
    value: 'fineguardacr75907.azurecr.io'
  - name: containerAppName
    value: 'fineguard-api'
  - name: postgresServer
    value: 'pgfineguardprod'
  - name: buildConfiguration
    value: 'Release'

stages:
  # ===================================================================
  # STAGE 1: INFRASTRUCTURE AS CODE
  # ===================================================================
  - stage: Infrastructure
    displayName: 'Provision Azure Infrastructure'
    jobs:
      - job: DeployInfrastructure
        displayName: 'Deploy Bicep Templates'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy Infrastructure'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ðŸ—ï¸  Deploying Azure Infrastructure..."

                # Deploy main infrastructure
                az deployment group create \
                  --resource-group $(resourceGroup) \
                  --template-file azure/main.bicep \
                  --parameters azure/parameters.json \
                  --parameters \
                    environment=production \
                    location=$(location) \
                    postgresAdminPassword="$(POSTGRES_ADMIN_PASSWORD)"

                echo "âœ… Infrastructure deployed"

          - task: AzureCLI@2
            displayName: 'Configure Firewall Rules'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Allow Azure services
                az postgres flexible-server firewall-rule create \
                  --resource-group $(resourceGroup) \
                  --name $(postgresServer) \
                  --rule-name AllowAzureServices \
                  --start-ip-address 0.0.0.0 \
                  --end-ip-address 0.0.0.0

                # Allow Container Apps subnet
                SUBNET_ID=$(az containerapp env show \
                  --name fineguard-env \
                  --resource-group $(resourceGroup) \
                  --query properties.infrastructureSubnetId -o tsv)

                echo "âœ… Firewall rules configured"

  # ===================================================================
  # STAGE 2: BUILD & TEST
  # ===================================================================
  - stage: Build
    displayName: 'Build and Test Application'
    dependsOn: Infrastructure
    condition: succeeded()
    jobs:
      - job: CodeQuality
        displayName: 'Code Quality & Security Scan'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'

          - script: |
              npm ci
              npm run lint --if-present
              npm audit --audit-level=high
            displayName: 'Lint and security audit'

          - task: SonarCloudPrepare@2
            inputs:
              SonarCloud: 'SonarCloud'
              organization: 'fineguard'
              scannerMode: 'CLI'
              configMode: 'manual'
              cliProjectKey: 'fineguard-api'
              cliProjectName: 'FineGuard API'

      - job: BuildAndPushDocker
        displayName: 'Build Docker Images'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: 'fineguardacr75907'

          - task: Docker@2
            displayName: 'Build Backend Image'
            inputs:
              command: build
              repository: 'fineguard-api'
              dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
              tags: |
                $(Build.BuildId)
                latest
              arguments: '--build-arg NODE_ENV=production --build-arg BUILD_ID=$(Build.BuildId)'

          - task: Docker@2
            displayName: 'Scan Image for Vulnerabilities'
            inputs:
              command: 'run'
              arguments: '--rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image $(containerRegistry)/fineguard-api:$(Build.BuildId)'

          - task: Docker@2
            displayName: 'Push to ACR'
            inputs:
              command: push
              repository: 'fineguard-api'
              tags: |
                $(Build.BuildId)
                latest

      - job: BuildFrontend
        displayName: 'Build Frontend Application'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'

          - script: |
              cd client
              npm ci
              npm run build
              npm run test --if-present
            displayName: 'Build and test frontend'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Frontend Artifact'
            inputs:
              PathtoPublish: 'client/dist'
              ArtifactName: 'frontend-dist'

      - job: UnitTests
        displayName: 'Run Unit Tests'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'

          - script: |
              npm ci
              npm test -- --coverage --ci
            displayName: 'Run tests with coverage'

          - task: PublishCodeCoverageResults@2
            inputs:
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'
              codecoverageTool: 'Cobertura'

  # ===================================================================
  # STAGE 3: DATABASE MIGRATION
  # ===================================================================
  - stage: DatabaseMigration
    displayName: 'Database Schema Migration'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: BackupDatabase
        displayName: 'Backup Production Database'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            displayName: 'Create database backup'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                BACKUP_NAME="fineguard-backup-$(Build.BuildId)"

                az postgres flexible-server backup create \
                  --resource-group $(resourceGroup) \
                  --name $(postgresServer) \
                  --backup-name $BACKUP_NAME

                echo "âœ… Backup created: $BACKUP_NAME"

      - job: RunMigrations
        displayName: 'Run Database Migrations'
        dependsOn: BackupDatabase
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'

          - script: |
              npm ci
              npm run migrate
            displayName: 'Run migrations'
            env:
              DATABASE_URL: $(DATABASE_URL)

      - job: ImportData
        displayName: 'Import 5.8M Companies (if needed)'
        dependsOn: RunMigrations
        condition: eq(variables['IMPORT_COMPANIES'], 'true')
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 120
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'

          - task: DownloadSecureFile@1
            name: companiesCSV
            displayName: 'Download Companies CSV'
            inputs:
              secureFile: 'BasicCompanyDataAsOneFile-2025-12-01.csv'

          - script: |
              npm ci
              node scripts/import-companies-azure.js
            displayName: 'Import companies data'
            env:
              DATABASE_URL: $(DATABASE_URL)
              CSV_FILE: $(companiesCSV.secureFilePath)

  # ===================================================================
  # STAGE 4: DEPLOY TO STAGING
  # ===================================================================
  - stage: DeployStaging
    displayName: 'Deploy to Staging Environment'
    dependsOn: DatabaseMigration
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
      - deployment: DeployBackendStaging
        displayName: 'Deploy Backend to Staging'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Deploy to Container Apps (Staging)'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az containerapp update \
                        --name fineguard-api-staging \
                        --resource-group $(resourceGroup) \
                        --image $(containerRegistry)/fineguard-api:$(Build.BuildId) \
                        --set-env-vars \
                          NODE_ENV=staging \
                          DATABASE_URL="$(DATABASE_URL_STAGING)" \
                          PORT=8080

      - deployment: DeployFrontendStaging
        displayName: 'Deploy Frontend to Staging'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: frontend-dist

                - task: AzureStaticWebApp@0
                  inputs:
                    app_location: '$(Pipeline.Workspace)/frontend-dist'
                    skip_app_build: true
                    azure_static_web_apps_api_token: $(STATIC_WEB_APP_TOKEN_STAGING)

  # ===================================================================
  # STAGE 5: DEPLOY TO PRODUCTION
  # ===================================================================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn:
      - Build
      - DatabaseMigration
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployBackendProduction
        displayName: 'Deploy Backend to Production'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            preDeploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Create deployment snapshot'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Get current revision for rollback
                      CURRENT_REVISION=$(az containerapp revision list \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --query "[0].name" -o tsv)

                      echo "##vso[task.setvariable variable=previousRevision]$CURRENT_REVISION"
                      echo "Current revision: $CURRENT_REVISION"

            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Blue-Green Deployment'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "ðŸš€ Starting blue-green deployment..."

                      # Deploy new revision (green)
                      az containerapp update \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --image $(containerRegistry)/fineguard-api:$(Build.BuildId) \
                        --revision-suffix v$(Build.BuildId) \
                        --set-env-vars \
                          NODE_ENV=production \
                          DATABASE_URL="$(DATABASE_URL)" \
                          COMPANIES_HOUSE_API_KEY="$(COMPANIES_HOUSE_API_KEY)" \
                          REDIS_URL="$(REDIS_URL)" \
                          PORT=8080 \
                        --cpu 2.0 \
                        --memory 4Gi \
                        --min-replicas 2 \
                        --max-replicas 10

                      echo "âœ… New revision deployed"

                      # Health check
                      sleep 30

                      FQDN=$(az containerapp show \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --query properties.configuration.ingress.fqdn -o tsv)

                      echo "Running health checks on https://$FQDN/health"

                      for i in {1..5}; do
                        if curl -f -s "https://$FQDN/health" | jq -e '.status == "healthy"'; then
                          echo "âœ… Health check $i passed"
                          break
                        else
                          echo "â³ Health check $i failed, retrying..."
                          sleep 10
                        fi
                      done

                      echo "âœ… Deployment successful"

            postRouteTraffic:
              steps:
                - task: AzureCLI@2
                  displayName: 'Gradual traffic shift (10% â†’ 100%)'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      NEW_REVISION="$(containerAppName)--v$(Build.BuildId)"

                      # Shift 10% traffic
                      echo "Shifting 10% traffic to new revision..."
                      az containerapp ingress traffic set \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --revision-weight $NEW_REVISION=10 $(previousRevision)=90

                      sleep 120 # Monitor for 2 minutes

                      # Shift 50% traffic
                      echo "Shifting 50% traffic to new revision..."
                      az containerapp ingress traffic set \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --revision-weight $NEW_REVISION=50 $(previousRevision)=50

                      sleep 180 # Monitor for 3 minutes

                      # Shift 100% traffic
                      echo "Shifting 100% traffic to new revision..."
                      az containerapp ingress traffic set \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --revision-weight $NEW_REVISION=100

                      echo "âœ… Traffic fully shifted to new revision"

                - task: AzureCLI@2
                  displayName: 'Deactivate old revisions'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Keep last 3 revisions, deactivate older ones
                      az containerapp revision list \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --query "[3:].name" -o tsv | \
                      while read revision; do
                        echo "Deactivating old revision: $revision"
                        az containerapp revision deactivate \
                          --name $(containerAppName) \
                          --resource-group $(resourceGroup) \
                          --revision $revision
                      done

      - deployment: DeployFrontendProduction
        displayName: 'Deploy Frontend to Production'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: frontend-dist

                - task: AzureStaticWebApp@0
                  inputs:
                    app_location: '$(Pipeline.Workspace)/frontend-dist'
                    skip_app_build: true
                    azure_static_web_apps_api_token: $(STATIC_WEB_APP_TOKEN)

  # ===================================================================
  # STAGE 6: POST-DEPLOYMENT VALIDATION
  # ===================================================================
  - stage: ValidationTests
    displayName: 'Post-Deployment Validation'
    dependsOn: DeployProduction
    jobs:
      - job: SmokeTests
        displayName: 'Run Smoke Tests'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            displayName: 'API Smoke Tests'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                FQDN=$(az containerapp show \
                  --name $(containerAppName) \
                  --resource-group $(resourceGroup) \
                  --query properties.configuration.ingress.fqdn -o tsv)

                echo "Running smoke tests against https://$FQDN"

                # Test 1: Health endpoint
                curl -f "https://$FQDN/health" || exit 1

                # Test 2: Companies API
                COMPANY_COUNT=$(curl -s "https://$FQDN/api/companies?limit=1" | jq -r '.companies | length')
                if [ "$COMPANY_COUNT" -ne 1 ]; then
                  echo "Companies API failed"
                  exit 1
                fi

                # Test 3: Accountants API
                ACCOUNTANT_COUNT=$(curl -s "https://$FQDN/api/accountants" | jq -r '.accountants | length')
                if [ "$ACCOUNTANT_COUNT" -lt 300 ]; then
                  echo "Accountants API failed (expected 390+, got $ACCOUNTANT_COUNT)"
                  exit 1
                fi

                echo "âœ… All smoke tests passed!"

      - job: PerformanceTests
        displayName: 'Performance Benchmark'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - script: |
              # Install k6 load testing tool
              sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
              echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
              sudo apt-get update
              sudo apt-get install k6

              # Run load test
              k6 run --vus 50 --duration 30s tests/load-test.js
            displayName: 'Load test with k6'

  # ===================================================================
  # STAGE 7: MONITORING & ALERTING
  # ===================================================================
  - stage: EnableMonitoring
    displayName: 'Configure Monitoring'
    dependsOn: ValidationTests
    jobs:
      - job: ConfigureAlerts
        displayName: 'Set up Application Insights Alerts'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            displayName: 'Create metric alerts'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # High error rate alert
                az monitor metrics alert create \
                  --name "High-Error-Rate" \
                  --resource-group $(resourceGroup) \
                  --scopes /subscriptions/$(AZURE_SUBSCRIPTION_ID)/resourceGroups/$(resourceGroup)/providers/Microsoft.App/containerApps/$(containerAppName) \
                  --condition "avg Http5xx > 10" \
                  --description "Alert when 5xx errors exceed 10 per minute" \
                  --evaluation-frequency 1m \
                  --window-size 5m \
                  --severity 2

                # High CPU alert
                az monitor metrics alert create \
                  --name "High-CPU-Usage" \
                  --resource-group $(resourceGroup) \
                  --scopes /subscriptions/$(AZURE_SUBSCRIPTION_ID)/resourceGroups/$(resourceGroup)/providers/Microsoft.App/containerApps/$(containerAppName) \
                  --condition "avg CpuUsage > 80" \
                  --description "Alert when CPU usage exceeds 80%" \
                  --evaluation-frequency 5m \
                  --window-size 15m \
                  --severity 3

                echo "âœ… Alerts configured"
