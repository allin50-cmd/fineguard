const express = require('express');
const cors = require('cors');
const { Pool } = require('pg');

const app = express();
const PORT = process.env.PORT || 8080;

// Database - Azure PostgreSQL requires SSL
const pool = new Pool({
  connectionString: process.env.DATABASE_URL || 'postgresql://fineguardadmin:FineGuard2025!Prod@pgfineguardprod.postgres.database.azure.com:5432/fineguard',
  ssl: {
    rejectUnauthorized: false
  }
});

// Middleware
app.use(cors());
app.use(express.json());

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'healthy', uptime: process.uptime() });
});

// Portal API - Client Dashboard
app.get('/api/portal/dashboard', async (req, res) => {
  try {
    // Get client
    const clientResult = await pool.query('SELECT * FROM clients LIMIT 1');
    if (!clientResult.rows.length) {
      return res.status(404).json({ error: 'No clients found' });
    }

    const client = clientResult.rows[0];

    // Get company from Companies House
    const companyResult = await pool.query(`
      SELECT * FROM companies
      WHERE company_number = $1
      LIMIT 1
    `, [client.company_number]);

    const company = companyResult.rows[0];

    // Calculate deadlines
    const deadlines = [];
    if (company) {
      const accountsDate = company.accounts_next_due_date ? new Date(company.accounts_next_due_date) : null;
      const confirmationDate = company.confirmation_statement_next_due_date ? new Date(company.confirmation_statement_next_due_date) : null;

      if (accountsDate && accountsDate > new Date()) {
        const daysUntil = Math.ceil((accountsDate - new Date()) / (1000 * 60 * 60 * 24));
        deadlines.push({
          id: 'accounts',
          deadline_type: 'Annual Accounts',
          deadline_date: accountsDate.toISOString(),
          case_title: `${company.company_name} - Annual Accounts`,
          status: daysUntil < 30 ? 'urgent' : 'upcoming',
          days_until: daysUntil
        });
      }

      if (confirmationDate && confirmationDate > new Date()) {
        const daysUntil = Math.ceil((confirmationDate - new Date()) / (1000 * 60 * 60 * 24));
        deadlines.push({
          id: 'confirmation',
          deadline_type: 'Confirmation Statement',
          deadline_date: confirmationDate.toISOString(),
          case_title: `${company.company_name} - Confirmation Statement`,
          status: daysUntil < 14 ? 'urgent' : 'upcoming',
          days_until: daysUntil
        });
      }
    }

    // Calculate health score
    let healthScore = 100;
    if (company) {
      if (company.company_status !== 'Active') healthScore -= 30;
      if (!company.accounts_next_due_date) healthScore -= 20;
      if (!company.confirmation_statement_next_due_date) healthScore -= 15;

      deadlines.forEach(d => {
        if (d.days_until < 7) healthScore -= 20;
        else if (d.days_until < 14) healthScore -= 10;
        else if (d.days_until < 30) healthScore -= 5;
      });

      healthScore = Math.max(0, healthScore);
    }

    res.json({
      client,
      company,
      metrics: {
        activeCases: deadlines.length,
        upcomingDeadlines: deadlines.filter(d => d.days_until <= 30).length,
        documentsCount: 0,
        accountStatus: company?.company_status || 'Unknown'
      },
      upcomingDeadlines: deadlines.sort((a, b) => a.days_until - b.days_until),
      recentCases: [],
      healthScore: {
        score: healthScore,
        trend: 'stable',
        lastCalculated: new Date().toISOString()
      }
    });
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to fetch dashboard data' });
  }
});

// Alerts endpoint
app.get('/api/portal/alerts', async (req, res) => {
  try {
    const clientResult = await pool.query('SELECT * FROM clients LIMIT 1');
    if (!clientResult.rows.length) {
      return res.json({ alerts: [] });
    }

    const client = clientResult.rows[0];
    const companyResult = await pool.query(`
      SELECT * FROM companies_house_full WHERE company_number = $1
    `, [client.company_number]);

    const company = companyResult.rows[0];
    const alerts = [];

    if (company) {
      const accountsDate = company.accounts_next_due_date ? new Date(company.accounts_next_due_date) : null;
      const confirmationDate = company.confirmation_statement_next_due_date ? new Date(company.confirmation_statement_next_due_date) : null;

      if (accountsDate && accountsDate > new Date()) {
        const daysUntil = Math.ceil((accountsDate - new Date()) / (1000 * 60 * 60 * 24));
        if (daysUntil <= 30) {
          alerts.push({
            type: daysUntil < 7 ? 'critical' : 'warning',
            title: 'Annual Accounts Due Soon',
            message: `Your annual accounts are due in ${daysUntil} days (${accountsDate.toLocaleDateString()})`,
            date: new Date().toISOString(),
            daysUntil
          });
        }
      }

      if (confirmationDate && confirmationDate > new Date()) {
        const daysUntil = Math.ceil((confirmationDate - new Date()) / (1000 * 60 * 60 * 24));
        if (daysUntil <= 14) {
          alerts.push({
            type: daysUntil < 7 ? 'critical' : 'warning',
            title: 'Confirmation Statement Due',
            message: `Your confirmation statement is due in ${daysUntil} days (${confirmationDate.toLocaleDateString()})`,
            date: new Date().toISOString(),
            daysUntil
          });
        }
      }

      if (company.company_status !== 'Active') {
        alerts.push({
          type: 'critical',
          title: 'Company Status Issue',
          message: `Your company status is "${company.company_status}". Please contact support immediately.`,
          date: new Date().toISOString()
        });
      }
    }

    res.json({ alerts });
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to fetch alerts' });
  }
});

// Companies endpoint
app.get('/api/companies', async (req, res) => {
  try {
    const { limit = 50, offset = 0, search, status } = req.query;
    let query = 'SELECT * FROM companies WHERE 1=1';
    const params = [];
    let paramCount = 0;

    if (search) {
      paramCount++;
      params.push(`%${search}%`);
      query += ` AND (company_name ILIKE $${paramCount} OR company_number ILIKE $${paramCount})`;
    }

    if (status) {
      paramCount++;
      params.push(status);
      query += ` AND company_status = $${paramCount}`;
    }

    query += ` ORDER BY company_name ASC LIMIT $${paramCount + 1} OFFSET $${paramCount + 2}`;
    params.push(parseInt(limit), parseInt(offset));

    const result = await pool.query(query, params);
    const countResult = await pool.query('SELECT COUNT(*) FROM companies WHERE 1=1');

    res.json({
      companies: result.rows,
      total: parseInt(countResult.rows[0].count)
    });
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to fetch companies' });
  }
});

// Companies stats
app.get('/api/companies/stats', async (req, res) => {
  try {
    const result = await pool.query(`
      SELECT
        COUNT(*) as total,
        COUNT(*) FILTER (WHERE company_status = 'Active') as active,
        COUNT(*) FILTER (WHERE company_status = 'Dissolved') as dissolved,
        COUNT(*) FILTER (WHERE company_status = 'Liquidation') as liquidation
      FROM companies
    `);
    res.json(result.rows[0]);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to fetch statistics' });
  }
});

// Accountants endpoint
app.get('/api/accountants', async (req, res) => {
  try {
    const result = await pool.query('SELECT * FROM accountants ORDER BY firm_name ASC');
    res.json({ accountants: result.rows });
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to fetch accountants' });
  }
});

// Accountants stats
app.get('/api/accountants/stats', async (req, res) => {
  try {
    const result = await pool.query(`
      SELECT
        COUNT(*) as total,
        COUNT(DISTINCT borough) as boroughs,
        COUNT(*) FILTER (WHERE email IS NOT NULL AND email != '') as "withEmail",
        COUNT(*) FILTER (WHERE phone IS NOT NULL AND phone != '') as "withPhone",
        COUNT(*) FILTER (WHERE website IS NOT NULL AND website != '') as "withWebsite"
      FROM accountants
    `);
    res.json(result.rows[0]);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to fetch statistics' });
  }
});

// Borough stats
app.get('/api/accountants/borough-stats', async (req, res) => {
  try {
    const result = await pool.query(`
      SELECT borough, COUNT(*) as firm_count
      FROM accountants
      WHERE borough IS NOT NULL
      GROUP BY borough
      ORDER BY firm_count DESC
    `);
    res.json({ stats: result.rows });
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to fetch borough statistics' });
  }
});

// Enrichment stats
app.get('/api/enrichment/stats', async (req, res) => {
  try {
    const result = await pool.query(`
      SELECT
        COUNT(*) as total,
        COUNT(*) FILTER (WHERE source = 'perplexity') as perplexity,
        COUNT(*) FILTER (WHERE source = 'generated') as generated,
        COUNT(*) FILTER (WHERE confidence >= 80) as "highConfidence"
      FROM enriched_companies
    `);
    res.json(result.rows[0]);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to fetch statistics' });
  }
});

// Enriched companies
app.get('/api/enrichment/companies', async (req, res) => {
  try {
    const result = await pool.query(`
      SELECT * FROM enriched_companies
      ORDER BY enriched_at DESC
      LIMIT 500
    `);
    res.json(result.rows);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ error: 'Failed to fetch enriched companies' });
  }
});

// Start server
app.listen(PORT, () => {
  console.log(`âœ… FineGuard Backend running on port ${PORT}`);
  console.log(`ğŸ“Š Portal Dashboard: http://localhost:${PORT}/api/portal/dashboard`);
  console.log(`ğŸš¨ Alerts: http://localhost:${PORT}/api/portal/alerts`);
  console.log(`ğŸ¢ Companies: http://localhost:${PORT}/api/companies`);
  console.log(`ğŸ‘” Accountants: http://localhost:${PORT}/api/accountants`);
});
