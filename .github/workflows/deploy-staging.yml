name: Deploy to Staging Environment

on:
  push:
    branches: [ staging ]
    paths-ignore:
      - '**.md'
      - '.github/**'

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    environment: staging
    steps:
    - uses: actions/checkout@v4
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}
    - name: Build and push Docker image
      run: |
        az acr login --name ${{ secrets.STAGING_ACR_NAME }}
        docker build --platform linux/amd64 -t ${{ secrets.STAGING_ACR_NAME }}.azurecr.io/backend:staging .
        docker push ${{ secrets.STAGING_ACR_NAME }}.azurecr.io/backend:staging
    - name: Deploy to Container App
      run: |
        az containerapp create \
          --name ${{ secrets.STAGING_CONTAINER_APP_NAME }} \
          --resource-group ${{ secrets.STAGING_RESOURCE_GROUP }} \
          --environment fineguard-env-staging \
          --image ${{ secrets.STAGING_ACR_NAME }}.azurecr.io/backend:staging \
          --target-port 8080 \
          --ingress external \
          --min-replicas 1 \
          --max-replicas 1 \
          --env-vars DATABASE_URL="${{ secrets.STAGING_DATABASE_URL }}"

  deploy-frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client
    steps:
    - uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
    - name: Install dependencies
      run: npm ci
    - name: Build
      run: npm run build
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS_STAGING }}
    - name: Upload to Azure Storage Static Website
      run: |
        az storage blob upload-batch \
          --account-name ${{ secrets.STAGING_STORAGE_ACCOUNT }} \
          --source dist \
          --destination '$web' \
          --overwrite
